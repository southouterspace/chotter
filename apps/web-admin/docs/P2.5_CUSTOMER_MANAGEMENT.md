# P2.5 - Customer Management Documentation

## Overview

The Customer Management feature provides a complete CRUD interface for managing customers in the admin dashboard. It includes list view, search/filtering, pagination, and detailed customer information with appointment history.

## Features Implemented

### 1. Customer List View (`CustomersPage.tsx`)
- **Location**: `/src/pages/CustomersPage.tsx`
- **Features**:
  - Displays all customers in a table format
  - Search functionality by name, phone, and email
  - Filter by customer status (active/inactive)
  - Pagination (20 customers per page)
  - "Add Customer" button to create new customers
  - Click row to view customer details

### 2. Customer Table Component (`CustomerTable.tsx`)
- **Location**: `/src/components/CustomerTable.tsx`
- **Columns**:
  - Name (first name + last name)
  - Email
  - Phone
  - Service Address
  - Status (badge with color coding)
- **Features**:
  - Real-time search with form submission
  - Status filter dropdown (All/Active/Inactive)
  - Pagination controls (Previous/Next)
  - Loading skeleton states
  - Error handling
  - Empty state with clear filters option
  - Results count display

### 3. Customer Form Component (`CustomerForm.tsx`)
- **Location**: `/src/components/CustomerForm.tsx`
- **Form Fields**:
  - **Basic Information**:
    - First Name (required)
    - Last Name (required)
    - Email (optional)
    - Phone (required)
    - Company Name (optional)
    - Status (active/inactive)
    - Source (referral/google_ads/website/repeat/other)
  - **Service Address** (required):
    - Street Address (with Google Places Autocomplete)
    - City
    - State (2-letter code)
    - ZIP Code
  - **Notes** (optional)

- **Features**:
  - Google Places Autocomplete for address input
  - Automatic address parsing and geocoding
  - Coordinates stored in service_address.coordinates as [longitude, latitude]
  - Form validation using Zod schema
  - Support for both create and edit modes
  - Loading states during submission

### 4. Customer Detail Component (`CustomerDetail.tsx`)
- **Location**: `/src/components/CustomerDetail.tsx`
- **Displays**:
  - Customer name and company
  - Status badge
  - Email (clickable mailto link)
  - Phone (clickable tel link)
  - Service address with map pin icon
  - Notes section
  - Appointment history table
- **Actions**:
  - Edit button (opens CustomerForm in edit mode)
  - Delete button (with confirmation dialog)
- **Appointment History**:
  - Displays all appointments for the customer
  - Shows date, service name, technician, and status
  - Empty state when no appointments exist
  - Sorted by scheduled date (most recent first)

## Custom Hooks

### `useCustomers(filters?: CustomerFilters)`
- **Location**: `/src/hooks/useCustomers.ts`
- **Purpose**: Fetch customers with pagination, search, and filtering
- **Returns**:
  ```typescript
  {
    data: {
      data: CustomerListItem[]
      count: number
      page: number
      pageSize: number
      totalPages: number
    }
    isLoading: boolean
    error: Error | null
  }
  ```
- **Filters**:
  - `search`: Search term for name/email/phone
  - `status`: 'active' | 'inactive'
  - `page`: Page number (default: 1)
  - `pageSize`: Items per page (default: 20)

### `useCustomer(customerId: string | null)`
- **Location**: `/src/hooks/useCustomer.ts`
- **Purpose**: Fetch single customer with appointment history
- **Returns**: Customer object with appointments array
- **Features**:
  - Joins with tickets table for appointments
  - Joins with services and technicians for display names
  - Returns null if customerId is null
  - Enabled only when customerId is provided

### `useCreateCustomer()`
- **Location**: `/src/hooks/useCreateCustomer.ts`
- **Purpose**: Create a new customer
- **Input**: CustomerFormData
- **Features**:
  - Stores coordinates in service_address.coordinates as [lng, lat]
  - Invalidates customers list cache on success
  - Handles business_id automatically

### `useUpdateCustomer()`
- **Location**: `/src/hooks/useUpdateCustomer.ts`
- **Purpose**: Update an existing customer
- **Input**: `{ id: string, data: CustomerFormData }`
- **Features**:
  - Stores coordinates in service_address.coordinates as [lng, lat]
  - Invalidates customers list and customer detail cache on success

### `useDeleteCustomer()`
- **Location**: `/src/hooks/useDeleteCustomer.ts`
- **Purpose**: Delete a customer
- **Input**: customerId (string)
- **Features**:
  - Invalidates customers list cache on success
  - Permanent deletion (no soft delete)

### `useGeocoding()`
- **Location**: `/src/hooks/useGeocoding.ts`
- **Purpose**: Geocode addresses to coordinates
- **Returns**:
  ```typescript
  {
    geocode: (address: Address) => Promise<GeocodedAddress>
    isLoading: boolean
    error: string | null
  }
  ```
- **Features**:
  - Uses Google Maps Geocoding API
  - Returns coordinates as { latitude, longitude }
  - Error handling for failed geocoding

## Validation Schema

### `customerSchema`
- **Location**: `/src/lib/validation/customer.ts`
- **Validation Rules**:
  - `first_name`: Required, max 100 chars
  - `last_name`: Required, max 100 chars
  - `email`: Optional, must be valid email format
  - `phone`: Required, min 10 chars, max 20 chars
  - `company_name`: Optional, max 200 chars
  - `status`: Required, enum ('active' | 'inactive')
  - `source`: Optional, enum (referral/google_ads/website/repeat/other)
  - `notes`: Optional, max 1000 chars
  - `service_address.street`: Required
  - `service_address.city`: Required
  - `service_address.state`: Required, exactly 2 chars
  - `service_address.zip`: Required, min 5 chars, max 10 chars
  - `service_address.latitude`: Optional number
  - `service_address.longitude`: Optional number

## Database Schema

### `customers` Table
```sql
{
  id: uuid (primary key)
  business_id: uuid (foreign key to businesses)
  first_name: text
  last_name: text
  email: text (nullable)
  phone: text
  company_name: text (nullable)
  source: customer_source enum (nullable)
  status: customer_status enum
  service_address: jsonb {
    street: string
    city: string
    state: string
    zip: string
    coordinates: [longitude, latitude]
  }
  billing_address: jsonb (nullable)
  tags: text[]
  notes: text (nullable)
  metadata: jsonb (nullable)
  created_at: timestamp
  updated_at: timestamp
}
```

## Google Maps Integration

### Setup
1. Set `VITE_GOOGLE_MAPS_API_KEY` in `.env.local`
2. Enable the following APIs in Google Cloud Console:
   - Maps JavaScript API
   - Places API
   - Geocoding API

### Address Autocomplete
- Implemented in CustomerForm using Google Places Autocomplete
- Restricted to US addresses (`componentRestrictions: { country: 'us' }`)
- Type restricted to addresses only
- Automatically parses and fills address components
- Extracts coordinates and stores in form state

### Coordinate Storage
- Coordinates stored as GeoJSON format: `[longitude, latitude]`
- Stored in `service_address.coordinates` field
- Used for proximity calculations and map features

## Usage Examples

### Create a New Customer
1. Navigate to Customers page
2. Click "Add Customer" button
3. Fill in required fields (name, phone, address)
4. Use autocomplete for service address
5. Optionally add email, company name, and notes
6. Click "Create Customer"

### Search for Customers
1. Type in the search box (searches name, email, phone)
2. Click "Search" or press Enter
3. Results update automatically
4. Use status filter dropdown for additional filtering

### Edit Customer
1. Click on customer row in table
2. Click "Edit" button in detail view
3. Update fields as needed
4. Click "Update Customer"

### Delete Customer
1. Click on customer row in table
2. Click "Delete" button in detail view
3. Confirm deletion in dialog
4. Customer is permanently removed

### View Appointment History
1. Click on customer row in table
2. Scroll to "Appointment History" section
3. View all past and upcoming appointments

## Testing Checklist

- [x] Customer list displays all customers with pagination
- [x] Search filters customers by name/phone/email
- [x] Status filter works correctly (all/active/inactive)
- [x] Pagination shows correct page counts
- [x] Can create new customer with geocoded address
- [x] Can edit existing customer
- [x] Can delete customer with confirmation
- [x] Can view customer details with appointment history
- [x] Form validation works correctly
- [x] Address autocomplete works
- [x] Coordinates are stored in database
- [x] Loading states display correctly
- [x] Error handling works for failed operations

## Future Enhancements

1. **Bulk Operations**
   - Select multiple customers
   - Bulk export to CSV
   - Bulk status updates

2. **Advanced Filtering**
   - Filter by source
   - Filter by date range
   - Filter by tag
   - Filter by appointment count

3. **Customer Insights**
   - Total revenue per customer
   - Average appointment frequency
   - Customer lifetime value
   - Service history analytics

4. **Communication Features**
   - Quick SMS/Email from detail view
   - Communication history timeline
   - Scheduled follow-ups

5. **Map Integration**
   - Show customer location on map
   - Territory view with all customers
   - Route optimization for technicians

## Performance Considerations

- Pagination limits initial data load to 20 records
- Search uses database-level ILIKE queries (indexed)
- Customer detail view lazy-loads appointment data
- Google Maps script loaded only when form is opened
- React Query caching reduces unnecessary API calls

## Accessibility

- All form inputs have proper labels
- Error messages are descriptive and visible
- Keyboard navigation supported throughout
- Focus management in dialogs
- Screen reader friendly status badges
- ARIA labels on interactive elements

## Security

- Row-level security (RLS) enforced on customers table
- Business_id automatically set from auth context
- Input validation on client and server
- SQL injection prevention via Supabase client
- No sensitive data in error messages

## Related Components

- `TechniciansPage.tsx` - Similar pattern for technician management
- `ServicesPage.tsx` - Similar pattern for service management
- `SchedulePage.tsx` - Uses customer data for appointment scheduling
- `AppointmentForm.tsx` - References customer data
